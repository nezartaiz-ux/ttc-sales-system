import jsPDF from 'jspdf';
import autoTable from 'jspdf-autotable';
import tehamaLogo from '@/assets/tehama-logo.png';

// Company information
const COMPANY_INFO = {
  name: "Tehama Trading Company",
  address: "Sana'a Regional Office",
  footer: {
    postBox: "Post Box: 73",
    location: "Sana'a, Yemen",
    phone: "Phone: 967 1 208916/400266",
    fax: "Fax: 967 1 466056"
  }
};

// Helper function to add header with logo and company info
const addReportHeader = (doc: jsPDF) => {
  // Company info on top-left
  doc.setFontSize(12);
  doc.setFont('helvetica', 'bold');
  doc.text(COMPANY_INFO.name, 14, 15);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.text(COMPANY_INFO.address, 14, 21);
  
  // Logo on top-right
  try {
    doc.addImage(tehamaLogo, 'PNG', 160, 10, 35, 20);
  } catch (e) {
    console.error('Error adding logo to PDF:', e);
  }
  
  return 30; // Return Y position where content should start
};

// Helper function to add footer
const addReportFooter = (doc: jsPDF, pageNum: number, totalPages: number) => {
  const pageHeight = doc.internal.pageSize.height;
  doc.setFontSize(8);
  doc.setFont('helvetica', 'normal');
  
  // Center footer with company info
  const footerText = `${COMPANY_INFO.footer.postBox} | ${COMPANY_INFO.footer.location} | ${COMPANY_INFO.footer.phone} | ${COMPANY_INFO.footer.fax}`;
  const textWidth = doc.getTextWidth(footerText);
  const centerX = (doc.internal.pageSize.width - textWidth) / 2;
  doc.text(footerText, centerX, pageHeight - 15);
  
  // Page number
  doc.text(
    `Page ${pageNum} of ${totalPages} - Generated on ${new Date().toLocaleDateString()}`,
    14,
    pageHeight - 10
  );
};

// Helper function to generate report serial number
const generateReportSerialNumber = (reportType: string) => {
  const now = new Date();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const year = String(now.getFullYear()).slice(-2);
  
  // Generate a sequential number based on timestamp (simple approach)
  const counter = String(now.getTime() % 10000).padStart(4, '0');
  
  let prefix = 'RP';
  switch(reportType.toLowerCase()) {
    case 'sales':
      prefix = 'RP-Sales';
      break;
    case 'inventory':
      prefix = 'RP-Inv';
      break;
    case 'purchase orders':
    case 'purchase_orders':
      prefix = 'RP-PO';
      break;
    case 'quotations':
      prefix = 'RP-Quot';
      break;
    default:
      prefix = 'RP-Gen';
  }
  
  return `${prefix}-${counter}-${month}-${year}`;
};

export const generateDetailedQuotationReport = (reportData: {
  title: string;
  dateRange?: string;
  quotations: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  // Generate report serial number
  const reportSerial = generateReportSerialNumber('quotations');
  
  // Add header with logo and company info
  addReportHeader(doc);
  
  // Report serial number
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  // Title
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  // Date range if provided
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  // Created by if provided
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  // Prepare table data
  const tableData = reportData.quotations.map((quotation: any) => {
    // Create items summary
    const itemsSummary = quotation.items.map((item: any) => 
      `${item.name} (${item.quantity})`
    ).join(', ');
    
    // Calculate discount and net amount
    const discountAmount = (quotation.discount_value && quotation.discount_value > 0)
      ? (quotation.discount_type === 'percentage'
        ? (quotation.total_amount * quotation.discount_value / 100)
        : quotation.discount_value)
      : 0;
    const netAmount = quotation.total_amount - discountAmount;
    
    // Discount display
    const discountDisplay = quotation.discount_value && quotation.discount_value > 0
      ? (quotation.discount_type === 'percentage' 
        ? `${quotation.discount_value}%`
        : `$${quotation.discount_value.toFixed(2)}`)
      : '-';
    
    return [
      quotation.quotation_number,
      new Date(quotation.created_at).toLocaleDateString(),
      itemsSummary,
      `$${netAmount.toFixed(2)}`,
      discountDisplay,
      `$${quotation.grand_total.toFixed(2)}`
    ];
  });
  
  // Create table
  autoTable(doc, {
    startY: tableStartY,
    head: [['Quotation #', 'Date', 'Details', 'Net Amount', 'Discount', 'Grand Total']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 25 },
      2: { cellWidth: 70 },
      3: { cellWidth: 25 },
      4: { cellWidth: 20 },
      5: { cellWidth: 25 }
    },
    margin: { left: 14, right: 14 }
  });
  
  // Add summary if needed
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.text(`Total Quotations: ${reportData.quotations.length}`, 14, finalY + 17);
  
  const totalGrand = reportData.quotations.reduce((sum, q) => sum + q.grand_total, 0);
  doc.text(`Total Amount: $${totalGrand.toFixed(2)}`, 14, finalY + 24);
  
  // Footer
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-quotations-report.pdf`;
  doc.save(filename);
};

// Helper function to format currency
const formatCurrency = (amount: number): string => {
  return '$' + Number(amount || 0).toLocaleString('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
};

// Helper function to translate status
const translateStatus = (status: string): string => {
  const statusMap: { [key: string]: string } = {
    'draft': 'Draft',
    'sent': 'Sent',
    'paid': 'Paid',
    'overdue': 'Overdue',
    'cancelled': 'Cancelled',
    'pending': 'Pending',
    'received': 'Received',
    'accepted': 'Accepted',
    'rejected': 'Rejected',
    'expired': 'Expired',
    'delivered': 'Delivered'
  };
  return statusMap[status?.toLowerCase()] || status || '-';
};

export const generateDetailedInventoryReport = (reportData: {
  title: string;
  dateRange?: string;
  items: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  // Generate report serial number
  const reportSerial = generateReportSerialNumber('inventory');
  
  // Add header with logo and company info
  addReportHeader(doc);
  
  // Report serial number
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  // Title
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  // Date range if provided
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  // Created by if provided
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  // Prepare table data with readable columns
  const tableData = reportData.items.map((item: any) => {
    return [
      item.name || '-',
      item.sku || '-',
      (item.quantity || 0).toLocaleString(),
      formatCurrency(item.unit_price || 0),
      formatCurrency(item.selling_price || 0),
      item.location || '-',
      item.is_active ? 'Active' : 'Inactive'
    ];
  });
  
  // Create table with proper headers
  autoTable(doc, {
    startY: tableStartY,
    head: [['Item Name', 'SKU', 'Qty', 'Cost Price', 'Selling Price', 'Location', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 45 },
      1: { cellWidth: 25 },
      2: { cellWidth: 20, halign: 'right' },
      3: { cellWidth: 25, halign: 'right' },
      4: { cellWidth: 25, halign: 'right' },
      5: { cellWidth: 25 },
      6: { cellWidth: 20 }
    },
    margin: { left: 14, right: 14 }
  });
  
  // Add summary
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.text(`Total Items: ${reportData.items.length}`, 14, finalY + 17);
  
  const totalValue = reportData.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.unit_price || 0)), 0);
  const totalSellingValue = reportData.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.selling_price || 0)), 0);
  const totalQuantity = reportData.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
  
  doc.text(`Total Quantity: ${totalQuantity.toLocaleString()}`, 14, finalY + 24);
  doc.text(`Total Cost Value: ${formatCurrency(totalValue)}`, 14, finalY + 31);
  doc.text(`Total Selling Value: ${formatCurrency(totalSellingValue)}`, 14, finalY + 38);
  
  // Footer
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-inventory-report.pdf`;
  doc.save(filename);
};

// Detailed Sales Report
export const generateDetailedSalesReport = (reportData: {
  title: string;
  dateRange?: string;
  invoices: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('sales');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.invoices.map((inv: any) => {
    const discountDisplay = inv.discount_value && inv.discount_value > 0
      ? (inv.discount_type === 'percentage' 
        ? `${inv.discount_value}%`
        : formatCurrency(inv.discount_value))
      : '-';
    
    return [
      inv.invoice_number || '-',
      new Date(inv.created_at).toLocaleDateString(),
      inv.customer_name || '-',
      inv.invoice_type === 'credit' ? 'Credit' : 'Cash',
      formatCurrency(inv.total_amount || 0),
      discountDisplay,
      formatCurrency(inv.grand_total || 0),
      translateStatus(inv.status)
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Invoice #', 'Date', 'Customer', 'Type', 'Subtotal', 'Discount', 'Total', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 25 },
      1: { cellWidth: 22 },
      2: { cellWidth: 35 },
      3: { cellWidth: 18 },
      4: { cellWidth: 22, halign: 'right' },
      5: { cellWidth: 18, halign: 'right' },
      6: { cellWidth: 22, halign: 'right' },
      7: { cellWidth: 20 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalInvoices = reportData.invoices.length;
  const totalAmount = reportData.invoices.reduce((sum, inv) => sum + (inv.grand_total || 0), 0);
  const paidAmount = reportData.invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (inv.grand_total || 0), 0);
  const pendingAmount = reportData.invoices.filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled').reduce((sum, inv) => sum + (inv.grand_total || 0), 0);
  
  doc.text(`Total Invoices: ${totalInvoices}`, 14, finalY + 17);
  doc.text(`Total Amount: ${formatCurrency(totalAmount)}`, 14, finalY + 24);
  doc.text(`Paid Amount: ${formatCurrency(paidAmount)}`, 14, finalY + 31);
  doc.text(`Pending Amount: ${formatCurrency(pendingAmount)}`, 14, finalY + 38);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-sales-report.pdf`;
  doc.save(filename);
};

// Detailed Purchase Orders Report
export const generateDetailedPOReport = (reportData: {
  title: string;
  dateRange?: string;
  orders: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('purchase_orders');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.orders.map((po: any) => {
    return [
      po.order_number || '-',
      new Date(po.created_at).toLocaleDateString(),
      po.supplier_name || '-',
      po.expected_delivery_date ? new Date(po.expected_delivery_date).toLocaleDateString() : '-',
      formatCurrency(po.total_amount || 0),
      formatCurrency(po.tax_amount || 0),
      formatCurrency(po.grand_total || 0),
      translateStatus(po.status)
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['PO #', 'Date', 'Supplier', 'Expected Delivery', 'Subtotal', 'Tax', 'Total', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 22 },
      1: { cellWidth: 22 },
      2: { cellWidth: 35 },
      3: { cellWidth: 25 },
      4: { cellWidth: 22, halign: 'right' },
      5: { cellWidth: 18, halign: 'right' },
      6: { cellWidth: 22, halign: 'right' },
      7: { cellWidth: 18 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalOrders = reportData.orders.length;
  const totalAmount = reportData.orders.reduce((sum, po) => sum + (po.grand_total || 0), 0);
  const receivedOrders = reportData.orders.filter(po => po.status === 'received').length;
  const pendingOrders = reportData.orders.filter(po => po.status !== 'received' && po.status !== 'cancelled').length;
  
  doc.text(`Total Orders: ${totalOrders}`, 14, finalY + 17);
  doc.text(`Total Amount: ${formatCurrency(totalAmount)}`, 14, finalY + 24);
  doc.text(`Received Orders: ${receivedOrders}`, 14, finalY + 31);
  doc.text(`Pending Orders: ${pendingOrders}`, 14, finalY + 38);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-purchase-orders-report.pdf`;
  doc.save(filename);
};

// Detailed Customers Report
export const generateDetailedCustomersReport = (reportData: {
  title: string;
  dateRange?: string;
  customers: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('customers');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.customers.map((customer: any) => {
    return [
      customer.name || '-',
      customer.email || '-',
      customer.phone || '-',
      customer.address || '-',
      customer.credit_limit ? formatCurrency(customer.credit_limit) : '-',
      customer.is_active ? 'Active' : 'Inactive'
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Customer Name', 'Email', 'Phone', 'Address', 'Credit Limit', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 35 },
      1: { cellWidth: 40 },
      2: { cellWidth: 25 },
      3: { cellWidth: 40 },
      4: { cellWidth: 25, halign: 'right' },
      5: { cellWidth: 18 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalCustomers = reportData.customers.length;
  const activeCustomers = reportData.customers.filter(c => c.is_active).length;
  const totalCreditLimit = reportData.customers.reduce((sum, c) => sum + (c.credit_limit || 0), 0);
  
  doc.text(`Total Customers: ${totalCustomers}`, 14, finalY + 17);
  doc.text(`Active Customers: ${activeCustomers}`, 14, finalY + 24);
  doc.text(`Total Credit Limit: ${formatCurrency(totalCreditLimit)}`, 14, finalY + 31);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-customers-report.pdf`;
  doc.save(filename);
};

// Detailed Suppliers Report
export const generateDetailedSuppliersReport = (reportData: {
  title: string;
  dateRange?: string;
  suppliers: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('suppliers');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.suppliers.map((supplier: any) => {
    return [
      supplier.name || '-',
      supplier.contact_person || '-',
      supplier.email || '-',
      supplier.phone || '-',
      supplier.address || '-',
      supplier.is_active ? 'Active' : 'Inactive'
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Supplier Name', 'Contact Person', 'Email', 'Phone', 'Address', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 35 },
      1: { cellWidth: 30 },
      2: { cellWidth: 35 },
      3: { cellWidth: 25 },
      4: { cellWidth: 35 },
      5: { cellWidth: 18 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalSuppliers = reportData.suppliers.length;
  const activeSuppliers = reportData.suppliers.filter(s => s.is_active).length;
  
  doc.text(`Total Suppliers: ${totalSuppliers}`, 14, finalY + 17);
  doc.text(`Active Suppliers: ${activeSuppliers}`, 14, finalY + 24);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-suppliers-report.pdf`;
  doc.save(filename);
};

// Detailed Delivery Notes Report
export const generateDetailedDeliveryNotesReport = (reportData: {
  title: string;
  dateRange?: string;
  deliveryNotes: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('delivery_notes');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.deliveryNotes.map((dn: any) => {
    return [
      dn.delivery_note_number || '-',
      new Date(dn.delivery_note_date).toLocaleDateString(),
      dn.customer_name || '-',
      dn.invoice_number || '-',
      dn.warranty_type || '-',
      dn.driver_name || '-',
      translateStatus(dn.status)
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['DN #', 'Date', 'Customer', 'Invoice Ref', 'Warranty', 'Driver', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 28 },
      1: { cellWidth: 24 },
      2: { cellWidth: 35 },
      3: { cellWidth: 28 },
      4: { cellWidth: 25 },
      5: { cellWidth: 25 },
      6: { cellWidth: 20 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalNotes = reportData.deliveryNotes.length;
  const deliveredNotes = reportData.deliveryNotes.filter(dn => dn.status === 'delivered').length;
  const pendingNotes = reportData.deliveryNotes.filter(dn => dn.status === 'pending').length;
  
  doc.text(`Total Delivery Notes: ${totalNotes}`, 14, finalY + 17);
  doc.text(`Delivered: ${deliveredNotes}`, 14, finalY + 24);
  doc.text(`Pending: ${pendingNotes}`, 14, finalY + 31);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-delivery-notes-report.pdf`;
  doc.save(filename);
};

export const generateReportPDF = (reportData: {
  title: string;
  dateRange?: string;
  headers: string[];
  rows: any[][];
  summary?: { label: string; value: string }[];
  reportType?: string;
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  // Generate report serial number
  const reportSerial = generateReportSerialNumber(reportData.reportType || reportData.title);
  
  // Add header with logo and company info
  addReportHeader(doc);
  
  // Report serial number
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  // Title
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  // Date range if provided
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  // Created by if provided
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  // Main table
  autoTable(doc, {
    startY: tableStartY,
    head: [reportData.headers],
    body: reportData.rows,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [63, 81, 181] }
  });
  
  // Summary section if provided
  if (reportData.summary && reportData.summary.length > 0) {
    const finalY = (doc as any).lastAutoTable.finalY || 60;
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Summary', 14, finalY + 10);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    reportData.summary.forEach((item, index) => {
      doc.text(`${item.label}: ${item.value}`, 14, finalY + 18 + (index * 7));
    });
  }
  
  // Footer
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const filename = `${reportSerial}-${reportData.title.toLowerCase().replace(/\s+/g, '-')}.pdf`;
  doc.save(filename);
};

// ========== PRINT FUNCTIONS ==========
// These functions generate PDF and open for printing instead of downloading

export const printDetailedQuotationReport = (reportData: {
  title: string;
  dateRange?: string;
  quotations: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('quotations');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.quotations.map((quotation: any) => {
    const itemsSummary = quotation.items.map((item: any) => 
      `${item.name} (${item.quantity})`
    ).join(', ');
    
    const discountAmount = (quotation.discount_value && quotation.discount_value > 0)
      ? (quotation.discount_type === 'percentage'
        ? (quotation.total_amount * quotation.discount_value / 100)
        : quotation.discount_value)
      : 0;
    const netAmount = quotation.total_amount - discountAmount;
    
    const discountDisplay = quotation.discount_value && quotation.discount_value > 0
      ? (quotation.discount_type === 'percentage' 
        ? `${quotation.discount_value}%`
        : `$${quotation.discount_value.toFixed(2)}`)
      : '-';
    
    return [
      quotation.quotation_number,
      new Date(quotation.created_at).toLocaleDateString(),
      itemsSummary,
      `$${netAmount.toFixed(2)}`,
      discountDisplay,
      `$${quotation.grand_total.toFixed(2)}`
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Quotation #', 'Date', 'Details', 'Net Amount', 'Discount', 'Grand Total']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 25 },
      2: { cellWidth: 70 },
      3: { cellWidth: 25 },
      4: { cellWidth: 20 },
      5: { cellWidth: 25 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.text(`Total Quotations: ${reportData.quotations.length}`, 14, finalY + 17);
  
  const totalGrand = reportData.quotations.reduce((sum, q) => sum + q.grand_total, 0);
  doc.text(`Total Amount: $${totalGrand.toFixed(2)}`, 14, finalY + 24);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const pdfBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(pdfBlob);
  window.open(blobUrl, '_blank');
};

export const printDetailedInventoryReport = (reportData: {
  title: string;
  dateRange?: string;
  items: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('inventory');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.items.map((item: any) => {
    return [
      item.name || '-',
      item.sku || '-',
      (item.quantity || 0).toLocaleString(),
      formatCurrency(item.unit_price || 0),
      formatCurrency(item.selling_price || 0),
      item.location || '-',
      item.is_active ? 'Active' : 'Inactive'
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Item Name', 'SKU', 'Qty', 'Cost Price', 'Selling Price', 'Location', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 45 },
      1: { cellWidth: 25 },
      2: { cellWidth: 20, halign: 'right' },
      3: { cellWidth: 25, halign: 'right' },
      4: { cellWidth: 25, halign: 'right' },
      5: { cellWidth: 25 },
      6: { cellWidth: 20 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  doc.text(`Total Items: ${reportData.items.length}`, 14, finalY + 17);
  
  const totalValue = reportData.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.unit_price || 0)), 0);
  const totalSellingValue = reportData.items.reduce((sum, item) => sum + ((item.quantity || 0) * (item.selling_price || 0)), 0);
  const totalQuantity = reportData.items.reduce((sum, item) => sum + (item.quantity || 0), 0);
  
  doc.text(`Total Quantity: ${totalQuantity.toLocaleString()}`, 14, finalY + 24);
  doc.text(`Total Cost Value: ${formatCurrency(totalValue)}`, 14, finalY + 31);
  doc.text(`Total Selling Value: ${formatCurrency(totalSellingValue)}`, 14, finalY + 38);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const pdfBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(pdfBlob);
  window.open(blobUrl, '_blank');
};

export const printDetailedSalesReport = (reportData: {
  title: string;
  dateRange?: string;
  invoices: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('sales');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.invoices.map((inv: any) => {
    const discountDisplay = inv.discount_value && inv.discount_value > 0
      ? (inv.discount_type === 'percentage' 
        ? `${inv.discount_value}%`
        : formatCurrency(inv.discount_value))
      : '-';
    
    return [
      inv.invoice_number || '-',
      new Date(inv.created_at).toLocaleDateString(),
      inv.customer_name || '-',
      inv.invoice_type === 'credit' ? 'Credit' : 'Cash',
      formatCurrency(inv.total_amount || 0),
      discountDisplay,
      formatCurrency(inv.grand_total || 0),
      translateStatus(inv.status)
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Invoice #', 'Date', 'Customer', 'Type', 'Subtotal', 'Discount', 'Total', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 25 },
      1: { cellWidth: 22 },
      2: { cellWidth: 35 },
      3: { cellWidth: 18 },
      4: { cellWidth: 22, halign: 'right' },
      5: { cellWidth: 18, halign: 'right' },
      6: { cellWidth: 22, halign: 'right' },
      7: { cellWidth: 20 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalInvoices = reportData.invoices.length;
  const totalAmount = reportData.invoices.reduce((sum, inv) => sum + (inv.grand_total || 0), 0);
  const paidAmount = reportData.invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (inv.grand_total || 0), 0);
  const pendingAmount = reportData.invoices.filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled').reduce((sum, inv) => sum + (inv.grand_total || 0), 0);
  
  doc.text(`Total Invoices: ${totalInvoices}`, 14, finalY + 17);
  doc.text(`Total Amount: ${formatCurrency(totalAmount)}`, 14, finalY + 24);
  doc.text(`Paid Amount: ${formatCurrency(paidAmount)}`, 14, finalY + 31);
  doc.text(`Pending Amount: ${formatCurrency(pendingAmount)}`, 14, finalY + 38);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const pdfBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(pdfBlob);
  window.open(blobUrl, '_blank');
};

export const printDetailedPOReport = (reportData: {
  title: string;
  dateRange?: string;
  orders: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('purchase_orders');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.orders.map((po: any) => {
    return [
      po.order_number || '-',
      new Date(po.created_at).toLocaleDateString(),
      po.supplier_name || '-',
      po.expected_delivery_date ? new Date(po.expected_delivery_date).toLocaleDateString() : '-',
      formatCurrency(po.total_amount || 0),
      formatCurrency(po.tax_amount || 0),
      formatCurrency(po.grand_total || 0),
      translateStatus(po.status)
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['PO #', 'Date', 'Supplier', 'Expected Delivery', 'Subtotal', 'Tax', 'Total', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 22 },
      1: { cellWidth: 22 },
      2: { cellWidth: 35 },
      3: { cellWidth: 25 },
      4: { cellWidth: 22, halign: 'right' },
      5: { cellWidth: 18, halign: 'right' },
      6: { cellWidth: 22, halign: 'right' },
      7: { cellWidth: 18 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalOrders = reportData.orders.length;
  const totalAmount = reportData.orders.reduce((sum, po) => sum + (po.grand_total || 0), 0);
  const receivedOrders = reportData.orders.filter(po => po.status === 'received').length;
  const pendingOrders = reportData.orders.filter(po => po.status !== 'received' && po.status !== 'cancelled').length;
  
  doc.text(`Total Orders: ${totalOrders}`, 14, finalY + 17);
  doc.text(`Total Amount: ${formatCurrency(totalAmount)}`, 14, finalY + 24);
  doc.text(`Received Orders: ${receivedOrders}`, 14, finalY + 31);
  doc.text(`Pending Orders: ${pendingOrders}`, 14, finalY + 38);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const pdfBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(pdfBlob);
  window.open(blobUrl, '_blank');
};

export const printDetailedCustomersReport = (reportData: {
  title: string;
  dateRange?: string;
  customers: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('customers');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.customers.map((customer: any) => {
    return [
      customer.name || '-',
      customer.email || '-',
      customer.phone || '-',
      customer.address || '-',
      customer.credit_limit ? formatCurrency(customer.credit_limit) : '-',
      customer.is_active ? 'Active' : 'Inactive'
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Customer Name', 'Email', 'Phone', 'Address', 'Credit Limit', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 35 },
      1: { cellWidth: 40 },
      2: { cellWidth: 25 },
      3: { cellWidth: 40 },
      4: { cellWidth: 25, halign: 'right' },
      5: { cellWidth: 18 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalCustomers = reportData.customers.length;
  const activeCustomers = reportData.customers.filter(c => c.is_active).length;
  const totalCreditLimit = reportData.customers.reduce((sum, c) => sum + (c.credit_limit || 0), 0);
  
  doc.text(`Total Customers: ${totalCustomers}`, 14, finalY + 17);
  doc.text(`Active Customers: ${activeCustomers}`, 14, finalY + 24);
  doc.text(`Total Credit Limit: ${formatCurrency(totalCreditLimit)}`, 14, finalY + 31);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const pdfBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(pdfBlob);
  window.open(blobUrl, '_blank');
};

export const printDetailedSuppliersReport = (reportData: {
  title: string;
  dateRange?: string;
  suppliers: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('suppliers');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.suppliers.map((supplier: any) => {
    return [
      supplier.name || '-',
      supplier.contact_person || '-',
      supplier.email || '-',
      supplier.phone || '-',
      supplier.address || '-',
      supplier.is_active ? 'Active' : 'Inactive'
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['Supplier Name', 'Contact Person', 'Email', 'Phone', 'Address', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 35 },
      1: { cellWidth: 30 },
      2: { cellWidth: 35 },
      3: { cellWidth: 25 },
      4: { cellWidth: 35 },
      5: { cellWidth: 18 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalSuppliers = reportData.suppliers.length;
  const activeSuppliers = reportData.suppliers.filter(s => s.is_active).length;
  
  doc.text(`Total Suppliers: ${totalSuppliers}`, 14, finalY + 17);
  doc.text(`Active Suppliers: ${activeSuppliers}`, 14, finalY + 24);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const pdfBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(pdfBlob);
  window.open(blobUrl, '_blank');
};

export const printDetailedDeliveryNotesReport = (reportData: {
  title: string;
  dateRange?: string;
  deliveryNotes: any[];
  created_by_name?: string;
}) => {
  const doc = new jsPDF();
  
  const reportSerial = generateReportSerialNumber('delivery_notes');
  addReportHeader(doc);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text(`Report #: ${reportSerial}`, 14, 38);
  
  doc.setFontSize(18);
  doc.setFont('helvetica', 'bold');
  doc.text(reportData.title, 14, 48);
  
  if (reportData.dateRange) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(reportData.dateRange, 14, 56);
  }
  
  let tableStartY = reportData.dateRange ? 63 : 56;
  if (reportData.created_by_name) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(`Generated by: ${reportData.created_by_name}`, 14, tableStartY);
    tableStartY += 7;
  }
  
  const tableData = reportData.deliveryNotes.map((dn: any) => {
    return [
      dn.delivery_note_number || '-',
      new Date(dn.delivery_note_date).toLocaleDateString(),
      dn.customer_name || '-',
      dn.invoice_number || '-',
      dn.warranty_type || '-',
      dn.driver_name || '-',
      translateStatus(dn.status)
    ];
  });
  
  autoTable(doc, {
    startY: tableStartY,
    head: [['DN #', 'Date', 'Customer', 'Invoice Ref', 'Warranty', 'Driver', 'Status']],
    body: tableData,
    styles: { 
      fontSize: 8,
      cellPadding: 3,
      halign: 'left'
    },
    headStyles: { 
      fillColor: [63, 81, 181],
      halign: 'center'
    },
    columnStyles: {
      0: { cellWidth: 28 },
      1: { cellWidth: 24 },
      2: { cellWidth: 35 },
      3: { cellWidth: 28 },
      4: { cellWidth: 25 },
      5: { cellWidth: 25 },
      6: { cellWidth: 20 }
    },
    margin: { left: 14, right: 14 }
  });
  
  const finalY = (doc as any).lastAutoTable.finalY || tableStartY + 20;
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('Summary:', 14, finalY + 10);
  doc.setFontSize(9);
  doc.setFont('helvetica', 'normal');
  
  const totalNotes = reportData.deliveryNotes.length;
  const deliveredNotes = reportData.deliveryNotes.filter(dn => dn.status === 'delivered').length;
  const pendingNotes = reportData.deliveryNotes.filter(dn => dn.status === 'pending').length;
  
  doc.text(`Total Delivery Notes: ${totalNotes}`, 14, finalY + 17);
  doc.text(`Delivered: ${deliveredNotes}`, 14, finalY + 24);
  doc.text(`Pending: ${pendingNotes}`, 14, finalY + 31);
  
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    addReportFooter(doc, i, pageCount);
  }
  
  const pdfBlob = doc.output('blob');
  const blobUrl = URL.createObjectURL(pdfBlob);
  window.open(blobUrl, '_blank');
};
